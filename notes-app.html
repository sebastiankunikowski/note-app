<!DOCTYPE html>
<html lang="pl" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notatki - Material You</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              // Light Theme (Material You Inspired)
              light: {
                primary: "#3b82f6", // Blue 600
                "primary-container": "#dbeafe", // Blue 100
                "on-primary-container": "#1e40af", // Blue 800
                secondary: "#4f46e5", // Indigo 600
                "secondary-container": "#e0e7ff", // Indigo 100
                "on-secondary-container": "#3730a3", // Indigo 800
                tertiary: "#059669", // Emerald 600
                "tertiary-container": "#a7f3d0", // Emerald 200
                "on-tertiary-container": "#065f46", // Emerald 700
                error: "#dc2626", // Red 600
                "error-container": "#fee2e2", // Red 100
                "on-error-container": "#991b1b", // Red 800
                background: "#f8fafc", // Slate 50
                "on-background": "#0f172a", // Slate 900
                surface: "#ffffff", // White
                "on-surface": "#1e293b", // Slate 800
                "surface-variant": "#e2e8f0", // Slate 200
                "on-surface-variant": "#475569", // Slate 600
                outline: "#cbd5e1", // Slate 300
              },
              // Dark Theme (Material You Inspired)
              dark: {
                primary: "#60a5fa", // Blue 400
                "primary-container": "#1e3a8a", // Blue 800 (adjust for container)
                "on-primary-container": "#bfdbfe", // Blue 200
                secondary: "#818cf8", // Indigo 400
                "secondary-container": "#3730a3", // Indigo 800
                "on-secondary-container": "#c7d2fe", // Indigo 200
                tertiary: "#34d399", // Emerald 400
                "tertiary-container": "#065f46", // Emerald 700
                "on-tertiary-container": "#a7f3d0", // Emerald 200
                error: "#f87171", // Red 400
                "error-container": "#7f1d1d", // Red 900
                "on-error-container": "#fecaca", // Red 200
                background: "#111827", // Gray 900 (cooler dark)
                "on-background": "#f3f4f6", // Gray 100
                surface: "#1f2937", // Gray 800
                "on-surface": "#d1d5db", // Gray 300
                "surface-variant": "#374151", // Gray 700
                "on-surface-variant": "#9ca3af", // Gray 400
                outline: "#4b5563", // Gray 600
              },
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            boxShadow: {
              "m3-light":
                "0 1px 2px 0 rgba(0, 0, 0, 0.1), 0 1px 3px 0 rgba(0, 0, 0, 0.1)",
              "m3-dark":
                "0 1px 2px 0 rgba(0, 0, 0, 0.25), 0 1px 3px 0 rgba(0, 0, 0, 0.25)", // Darker, more subtle
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 300, "GRAD" 0, "opsz" 24;
        vertical-align: middle;
        font-size: 24px;
      }
      .material-symbols-outlined.fill {
        font-variation-settings: "FILL" 1;
      }

      /* Custom scrollbar for note content in modal */
      #note-content::-webkit-scrollbar,
      #voice-note-form .overflow-y-auto::-webkit-scrollbar,
      #tag-filter::-webkit-scrollbar {
        width: 8px;
      }
      #note-content::-webkit-scrollbar-track,
      #voice-note-form .overflow-y-auto::-webkit-scrollbar-track,
      #tag-filter::-webkit-scrollbar-track {
        background: transparent;
      }
      #note-content::-webkit-scrollbar-thumb,
      #voice-note-form .overflow-y-auto::-webkit-scrollbar-thumb,
      #tag-filter::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; /* light-outline */
        border-radius: 20px;
        border: 2px solid transparent; /* Creates padding around thumb */
        background-clip: content-box;
      }
      .dark #note-content::-webkit-scrollbar-thumb,
      .dark #voice-note-form .overflow-y-auto::-webkit-scrollbar-thumb,
      .dark #tag-filter::-webkit-scrollbar-thumb {
        background-color: #4b5563; /* dark-outline */
      }

      @keyframes pulse-opacity {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }
      .animate-pulse-opacity {
        animation: pulse-opacity 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Sidebar transition */
      #sidebar {
        transition: transform 0.3s ease-in-out;
      }
      .sidebar-open {
        transform: translateX(0) !important;
      }

      /* FAB Menu */
      #fab-menu {
        transition: opacity 0.2s ease-out, transform 0.2s ease-out;
      }
    </style>
  </head>
  <body
    class="bg-light-background dark:bg-dark-background text-light-on-background dark:text-dark-on-background antialiased"
  >
    <div class="flex flex-col md:flex-row min-h-screen">
      <aside
        id="sidebar"
        class="fixed inset-y-0 left-0 z-40 w-72 bg-light-surface dark:bg-dark-surface shadow-lg md:shadow-none md:relative md:translate-x-0 transform -translate-x-full md:flex md:flex-col p-4 border-r border-light-outline dark:border-dark-outline"
      >
        <div class="flex items-center mb-6 pt-2 md:pt-0">
          <span
            class="material-symbols-outlined text-3xl text-light-primary dark:text-dark-primary mr-2"
            >library_books</span
          >
          <h1
            class="text-xl font-semibold text-light-on-surface dark:text-dark-on-surface"
          >
            Moje Notatki
          </h1>
        </div>
        <nav class="flex-grow space-y-2">
          <h2
            class="text-xs font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant uppercase tracking-wider px-2 mb-2"
          >
            Filtry
          </h2>
          <div class="mb-4 px-2">
            <div class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span
                  class="material-symbols-outlined text-light-on-surface-variant dark:text-dark-on-surface-variant text-lg"
                  >search</span
                >
              </div>
              <input
                type="text"
                id="search-input"
                placeholder="Szukaj..."
                class="w-full pl-10 pr-3 py-2.5 text-sm bg-light-surface-variant dark:bg-dark-surface-variant border-none rounded-full focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary text-light-on-surface dark:text-dark-on-surface placeholder-light-on-surface-variant dark:placeholder-dark-on-surface-variant"
              />
            </div>
          </div>

          <a
            href="#"
            class="filter-type-button active-filter flex items-center px-3 py-2.5 rounded-full text-sm font-medium text-light-on-surface dark:text-dark-on-surface bg-light-primary-container dark:bg-dark-primary-container"
            data-filter="all"
          >
            <span
              class="material-symbols-outlined mr-3 text-light-on-primary-container dark:text-dark-on-primary-container"
              >list</span
            >
            Wszystkie
          </a>
          <a
            href="#"
            class="filter-type-button flex items-center px-3 py-2.5 rounded-full text-sm font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant"
            data-filter="text"
          >
            <span class="material-symbols-outlined mr-3">article</span> Tekstowe
          </a>
          <a
            href="#"
            class="filter-type-button flex items-center px-3 py-2.5 rounded-full text-sm font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant"
            data-filter="voice"
          >
            <span class="material-symbols-outlined mr-3">mic</span> GÅ‚osowe
          </a>

          <h3
            class="text-xs font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant uppercase tracking-wider px-2 pt-4 mb-1"
          >
            Tagi
          </h3>
          <div
            id="tag-filter"
            class="space-y-1 max-h-60 overflow-y-auto px-1"
          ></div>
        </nav>
        <div class="mt-auto pt-4">
          <button
            id="theme-toggle"
            class="w-full flex items-center justify-start p-3 rounded-full text-sm text-light-on-surface-variant dark:text-dark-on-surface-variant hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant transition-colors"
          >
            <span class="material-symbols-outlined mr-3"></span>
            <span id="theme-toggle-text"></span>
          </button>
        </div>
      </aside>
      <div
        id="sidebar-overlay"
        class="fixed inset-0 bg-black/30 z-30 hidden md:hidden"
        onclick="toggleSidebar()"
      ></div>

      <main class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto pb-24 md:pb-8">
        <div
          id="notes-container"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6"
        ></div>

        <div
          id="empty-state"
          class="text-center py-16 hidden flex-col items-center justify-center h-full"
        >
          <span
            class="material-symbols-outlined text-8xl mb-6 text-light-surface-variant dark:text-dark-surface-variant"
            >lightbulb</span
          >
          <h3
            class="text-xl font-medium text-light-on-surface dark:text-dark-on-surface mb-2"
          >
            Notatki, ktÃ³re tu dodasz, pojawiÄ… siÄ™ tutaj
          </h3>
          <p
            class="text-light-on-surface-variant dark:text-dark-on-surface-variant mb-6 max-w-xs"
          >
            Zacznij od utworzenia swojej pierwszej notatki uÅ¼ywajÄ…c przycisku +
          </p>
        </div>
      </main>
    </div>

    <div
      class="fixed bottom-0 left-0 right-0 md:hidden h-16 bg-light-surface dark:bg-dark-surface border-t border-light-outline dark:border-dark-outline flex items-center justify-between px-4 shadow-m3-light dark:shadow-m3-dark z-20"
    >
      <button
        id="menu-button"
        class="p-2 text-light-on-surface dark:text-dark-on-surface"
        onclick="toggleSidebar()"
      >
        <span class="material-symbols-outlined">menu</span>
      </button>
      <div class="relative">
        <div
          id="fab-menu"
          class="absolute bottom-full right-0 mb-3 space-y-2 opacity-0 transform scale-95 pointer-events-none"
        >
          <button
            id="add-voice-note-fab"
            class="w-max flex items-center bg-light-secondary-container dark:bg-dark-secondary-container text-light-on-secondary-container dark:text-dark-on-secondary-container px-4 py-2.5 rounded-xl shadow-md hover:shadow-lg transition-shadow text-sm font-medium"
          >
            <span class="material-symbols-outlined mr-2">mic</span> Nagraj gÅ‚os
          </button>
          <button
            id="add-text-note-fab"
            class="w-max flex items-center bg-light-tertiary-container dark:bg-dark-tertiary-container text-light-on-tertiary-container dark:text-dark-on-tertiary-container px-4 py-2.5 rounded-xl shadow-md hover:shadow-lg transition-shadow text-sm font-medium"
          >
            <span class="material-symbols-outlined mr-2">edit_note</span>
            Notatka tekstowa
          </button>
        </div>
        <button
          id="fab"
          class="bg-light-primary dark:bg-dark-primary text-white dark:text-black p-4 rounded-2xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-light-primary dark:focus:ring-dark-primary dark:focus:ring-offset-dark-surface transition-all duration-150"
        >
          <span
            class="material-symbols-outlined transform transition-transform duration-300"
            >add</span
          >
        </button>
      </div>
    </div>
    <div class="hidden md:block fixed bottom-8 right-8 z-20">
      <div class="relative">
        <div
          id="fab-menu-desktop"
          class="absolute bottom-full right-0 mb-3 space-y-2 opacity-0 transform scale-95 pointer-events-none"
        >
          <button
            id="add-voice-note-fab-desktop"
            class="w-max flex items-center bg-light-secondary-container dark:bg-dark-secondary-container text-light-on-secondary-container dark:text-dark-on-secondary-container px-4 py-2.5 rounded-xl shadow-md hover:shadow-lg transition-shadow text-sm font-medium"
          >
            <span class="material-symbols-outlined mr-2">mic</span> Nagraj gÅ‚os
          </button>
          <button
            id="add-text-note-fab-desktop"
            class="w-max flex items-center bg-light-tertiary-container dark:bg-dark-tertiary-container text-light-on-tertiary-container dark:text-dark-on-tertiary-container px-4 py-2.5 rounded-xl shadow-md hover:shadow-lg transition-shadow text-sm font-medium"
          >
            <span class="material-symbols-outlined mr-2">edit_note</span>
            Notatka tekstowa
          </button>
        </div>
        <button
          id="fab-desktop"
          class="bg-light-primary dark:bg-dark-primary text-white dark:text-black p-4 rounded-2xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-light-primary dark:focus:ring-dark-primary dark:focus:ring-offset-dark-surface transition-all duration-150"
        >
          <span
            class="material-symbols-outlined transform transition-transform duration-300"
            >add</span
          >
        </button>
      </div>
    </div>

    <div
      id="note-modal"
      class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-light-surface dark:bg-dark-surface rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-xl"
      >
        <div
          class="px-6 py-4 border-b border-light-outline dark:border-dark-outline"
        >
          <div class="flex items-center justify-between">
            <h2
              id="modal-title"
              class="text-lg font-medium text-light-on-surface dark:text-dark-on-surface"
            >
              Nowa notatka
            </h2>
            <button
              id="close-modal"
              class="p-2 text-light-on-surface-variant dark:text-dark-on-surface-variant hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant rounded-full"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>

        <div class="px-6 py-5 overflow-y-auto flex-grow">
          <div id="text-note-form">
            <div class="mb-5">
              <label
                class="block text-xs font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant mb-1"
                >TytuÅ‚</label
              >
              <input
                type="text"
                id="note-title"
                class="w-full px-4 py-2.5 border border-light-outline dark:border-dark-outline rounded-lg bg-light-surface dark:bg-dark-surface focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-light-primary dark:focus:border-dark-primary text-light-on-surface dark:text-dark-on-surface text-sm"
              />
            </div>
            <div class="mb-5">
              <label
                class="block text-xs font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant mb-1"
                >TreÅ›Ä‡</label
              >
              <textarea
                id="note-content"
                rows="8"
                class="w-full px-4 py-2.5 border border-light-outline dark:border-dark-outline rounded-lg bg-light-surface dark:bg-dark-surface focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-light-primary dark:focus:border-dark-primary resize-none text-light-on-surface dark:text-dark-on-surface text-sm"
              ></textarea>
            </div>
          </div>

          <div
            id="voice-note-form"
            class="hidden flex flex-col items-center justify-center h-full"
          >
            <div class="w-full mb-5">
              <label
                class="block text-xs font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant mb-1"
                >TytuÅ‚</label
              >
              <input
                type="text"
                id="voice-note-title"
                class="w-full px-4 py-2.5 border border-light-outline dark:border-dark-outline rounded-lg bg-light-surface dark:bg-dark-surface focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-light-primary dark:focus:border-dark-primary text-light-on-surface dark:text-dark-on-surface text-sm"
              />
            </div>

            <div
              class="text-center mb-6 flex-grow flex flex-col items-center justify-center"
            >
              <div id="recording-status" class="mb-4">
                <button
                  id="record-button"
                  class="flex items-center justify-center w-20 h-20 bg-light-error dark:bg-dark-error hover:opacity-90 rounded-full text-white cursor-pointer transition-opacity"
                >
                  <span class="material-symbols-outlined text-4xl">mic</span>
                </button>
                <p
                  class="mt-3 text-sm text-light-on-surface-variant dark:text-dark-on-surface-variant"
                >
                  NaciÅ›nij, aby nagraÄ‡
                </p>
              </div>

              <div
                id="recording-controls"
                class="hidden items-center justify-center space-x-4"
              >
                <div
                  id="recording-timer"
                  class="text-lg font-mono text-light-error dark:text-dark-error mr-2 tabular-nums"
                >
                  00:00
                </div>
                <button
                  id="pause-recording"
                  class="p-3 bg-light-secondary-container dark:bg-dark-secondary-container text-light-on-secondary-container dark:text-dark-on-secondary-container rounded-full hover:opacity-90"
                >
                  <span class="material-symbols-outlined">pause</span>
                </button>
                <button
                  id="stop-recording"
                  class="p-3 bg-light-error-container dark:bg-dark-error-container text-light-on-error-container dark:text-dark-on-error-container rounded-full hover:opacity-90"
                >
                  <span class="material-symbols-outlined">stop</span>
                </button>
              </div>
            </div>

            <div id="audio-playback" class="hidden w-full mt-4">
              <audio id="recorded-audio" controls class="w-full mb-3"></audio>
              <div class="text-center">
                <button
                  id="re-record"
                  class="px-5 py-2.5 bg-light-surface-variant dark:bg-dark-surface-variant text-light-on-surface-variant dark:text-dark-on-surface-variant rounded-full hover:opacity-90 text-sm font-medium flex items-center justify-center mx-auto"
                >
                  <span class="material-symbols-outlined mr-2 text-sm"
                    >refresh</span
                  >
                  Nagraj ponownie
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label
              class="block text-xs font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant mb-1.5"
              >Tagi</label
            >
            <div
              id="tag-chip-input-container"
              class="flex flex-wrap gap-2 p-2.5 border border-light-outline dark:border-dark-outline rounded-lg mb-2 min-h-[44px]"
            ></div>
            <input
              type="text"
              id="note-tags-input"
              placeholder="Wpisz tag i naciÅ›nij Enter"
              class="w-full px-4 py-2.5 border border-light-outline dark:border-dark-outline rounded-lg bg-light-surface dark:bg-dark-surface focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-light-primary dark:focus:border-dark-primary text-light-on-surface dark:text-dark-on-surface text-sm"
            />
          </div>

          <div class="mt-5">
            <label
              class="block text-xs font-medium text-light-on-surface-variant dark:text-dark-on-surface-variant mb-1"
              >Przypomnienie</label
            >
            <input
              type="datetime-local"
              id="note-reminder"
              class="w-full px-4 py-2.5 border border-light-outline dark:border-dark-outline rounded-lg bg-light-surface dark:bg-dark-surface focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-light-primary dark:focus:border-dark-primary text-light-on-surface dark:text-dark-on-surface text-sm"
            />
          </div>

          <div class="mt-5">
            <label class="inline-flex items-center cursor-pointer group">
              <input type="checkbox" id="note-favorite" class="sr-only peer" />
              <span
                class="material-symbols-outlined text-light-on-surface-variant dark:text-dark-on-surface-variant peer-checked:text-yellow-500 dark:peer-checked:text-yellow-400 peer-checked:font-['Material_Symbols_Outlined_Fill'] peer-checked:fill"
                >star</span
              >
              <span
                class="ml-2 text-sm text-light-on-surface-variant dark:text-dark-on-surface-variant group-hover:text-light-on-surface dark:group-hover:text-dark-on-surface"
                >Oznacz jako waÅ¼nÄ…</span
              >
            </label>
          </div>
        </div>

        <div
          class="px-6 py-4 border-t border-light-outline dark:border-dark-outline flex justify-end space-x-3"
        >
          <button
            id="cancel-note"
            class="px-5 py-2.5 text-sm font-medium text-light-primary dark:text-dark-primary hover:bg-light-primary/10 dark:hover:bg-dark-primary/10 rounded-full transition-colors"
          >
            Anuluj
          </button>
          <button
            id="save-note"
            class="px-6 py-2.5 text-sm font-medium bg-light-primary dark:bg-dark-primary text-white dark:text-dark-background rounded-full hover:opacity-90 transition-opacity"
          >
            Zapisz
          </button>
        </div>
      </div>
    </div>

    <div
      id="confirm-modal"
      class="fixed inset-0 bg-black/50 dark:bg-black/70 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-light-surface dark:bg-dark-surface rounded-3xl max-w-sm w-full p-6 shadow-xl"
      >
        <h3
          class="text-lg font-medium text-light-on-surface dark:text-dark-on-surface mb-3"
        >
          PotwierdÅº akcjÄ™
        </h3>
        <p
          id="confirm-message"
          class="text-sm text-light-on-surface-variant dark:text-dark-on-surface-variant mb-6"
        ></p>
        <div class="flex justify-end space-x-3">
          <button
            id="confirm-cancel"
            class="px-5 py-2.5 text-sm font-medium text-light-secondary dark:text-dark-secondary hover:bg-light-secondary/10 dark:hover:bg-dark-secondary/10 rounded-full transition-colors"
          >
            Anuluj
          </button>
          <button
            id="confirm-delete"
            class="px-5 py-2.5 text-sm font-medium bg-light-error dark:bg-dark-error text-white dark:text-dark-background rounded-full hover:opacity-90 transition-opacity"
          >
            UsuÅ„
          </button>
        </div>
      </div>
    </div>

    <div
      id="toast-container"
      class="fixed bottom-4 md:bottom-auto md:top-6 left-1/2 -translate-x-1/2 md:left-auto md:right-6 md:-translate-x-0 z-[100] space-y-2 w-auto max-w-[calc(100%-2rem)]"
    ></div>

    <script>
      // Global variables
      let notes = [];
      let currentNote = null;
      let currentTags = new Set();
      let mediaRecorder = null;
      let audioChunks = [];
      let recordedAudioBlob = null;
      let recordingStartTime = 0;
      let recordingTimerInterval = null;
      let isDarkMode = false;

      // DOM Elements
      const noteModal = document.getElementById("note-modal");
      const confirmModal = document.getElementById("confirm-modal");
      const themeToggleButton = document.getElementById("theme-toggle");
      const themeToggleText = document.getElementById("theme-toggle-text");
      const favoriteCheckbox = document.getElementById("note-favorite");
      const fab = document.getElementById("fab");
      const fabMenu = document.getElementById("fab-menu");
      const fabIcon = fab.querySelector(".material-symbols-outlined");
      const fabDesktop = document.getElementById("fab-desktop");
      const fabMenuDesktop = document.getElementById("fab-menu-desktop");
      const fabIconDesktop = fabDesktop.querySelector(
        ".material-symbols-outlined"
      );

      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebar-overlay");

      // Initialize app
      document.addEventListener("DOMContentLoaded", async function () {
        loadPreferences();
        await initIndexedDB();
        await loadNotes();
        renderNotes();
        updateTagFilterUI();
        setupEventListeners();
        setupAutoSave();

        if ("Notification" in window) {
          await Notification.requestPermission();
        }
        notes.forEach((note) => {
          if (note.reminderAt && note.reminderAt > Date.now()) {
            setReminder(note);
          }
        });
      });

      function toggleSidebar() {
        sidebar.classList.toggle("sidebar-open");
        sidebarOverlay.classList.toggle("hidden");
        // Optional: Prevent body scroll when sidebar is open on mobile
        // document.body.classList.toggle('overflow-hidden', sidebar.classList.contains('sidebar-open'));
      }

      // IndexedDB setup (version 2 for potential schema changes)
      let db;
      async function initIndexedDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("NotesAppDB_M3", 2);
          request.onerror = (event) =>
            reject("BÅ‚Ä…d IndexedDB: " + event.target.error);
          request.onsuccess = (event) => {
            db = event.target.result;
            resolve();
          };
          request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains("notes")) {
              const store = db.createObjectStore("notes", { keyPath: "id" });
              store.createIndex("type", "type", { unique: false });
              store.createIndex("createdAt", "createdAt", { unique: false });
              store.createIndex("tags", "tags", { multiEntry: true });
            }
          };
        });
      }

      // Database operations
      async function saveNoteToDb(note) {
        /* ... (same as before) ... */
        return new Promise((resolve, reject) => {
          if (!db) return reject("Baza danych nie jest zainicjalizowana.");
          const transaction = db.transaction(["notes"], "readwrite");
          const store = transaction.objectStore("notes");
          const request = store.put(note);
          request.onsuccess = () => resolve();
          request.onerror = (event) =>
            reject("BÅ‚Ä…d zapisu do IndexedDB: " + event.target.error);
        });
      }
      async function loadNotesFromDb() {
        /* ... (same as before) ... */
        return new Promise((resolve, reject) => {
          if (!db) return reject("Baza danych nie jest zainicjalizowana.");
          const transaction = db.transaction(["notes"], "readonly");
          const store = transaction.objectStore("notes");
          const request = store.getAll();
          request.onsuccess = (event) => resolve(event.target.result);
          request.onerror = (event) =>
            reject("BÅ‚Ä…d odczytu z IndexedDB: " + event.target.error);
        });
      }
      async function deleteNoteFromDb(id) {
        /* ... (same as before) ... */
        return new Promise((resolve, reject) => {
          if (!db) return reject("Baza danych nie jest zainicjalizowana.");
          const transaction = db.transaction(["notes"], "readwrite");
          const store = transaction.objectStore("notes");
          const request = store.delete(id);
          request.onsuccess = () => resolve();
          request.onerror = (event) =>
            reject("BÅ‚Ä…d usuwania z IndexedDB: " + event.target.error);
        });
      }

      // Load notes
      async function loadNotes() {
        try {
          notes = await loadNotesFromDb();
          notes.sort((a, b) => b.createdAt - a.createdAt);
        } catch (error) {
          console.error("BÅ‚Ä…d Å‚adowania notatek:", error);
          showToast("BÅ‚Ä…d podczas Å‚adowania notatek", "error");
        }
      }

      // Render notes
      function renderNotes() {
        const container = document.getElementById("notes-container");
        const emptyState = document.getElementById("empty-state");
        const filteredNotes = filterNotes();

        if (filteredNotes.length === 0) {
          container.innerHTML = "";
          container.classList.remove(
            "sm:grid-cols-2",
            "lg:grid-cols-3",
            "xl:grid-cols-4"
          ); // Clear grid classes
          emptyState.classList.remove("hidden");
          emptyState.classList.add("flex");
        } else {
          emptyState.classList.add("hidden");
          emptyState.classList.remove("flex");
          container.classList.add(
            "sm:grid-cols-2",
            "lg:grid-cols-3",
            "xl:grid-cols-4"
          ); // Ensure grid classes are present
          container.innerHTML = filteredNotes
            .map((note) => createNoteCard(note))
            .join("");
        }
      }

      // Filter notes
      function filterNotes() {
        let filtered = [...notes];
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();
        if (searchTerm) {
          filtered = filtered.filter(
            (note) =>
              note.title.toLowerCase().includes(searchTerm) ||
              (note.type === "text" &&
                note.content.toLowerCase().includes(searchTerm)) ||
              note.tags.some((tag) => tag.toLowerCase().includes(searchTerm))
          );
        }

        const activeTypeFilter = document.querySelector(
          ".filter-type-button.active-filter"
        );
        const typeFilterValue = activeTypeFilter
          ? activeTypeFilter.dataset.filter
          : "all";
        if (typeFilterValue !== "all") {
          filtered = filtered.filter((note) => note.type === typeFilterValue);
        }

        const selectedTags = Array.from(
          document.querySelectorAll(
            '#tag-filter input[type="checkbox"]:checked'
          )
        ).map((cb) => cb.value);
        if (selectedTags.length > 0) {
          filtered = filtered.filter((note) =>
            selectedTags.every((selTag) => note.tags.includes(selTag))
          );
        }
        return filtered;
      }

      // Create note card HTML
      function createNoteCard(note) {
        const date = new Date(note.createdAt).toLocaleDateString("pl-PL", {
          day: "numeric",
          month: "short",
        });

        const tagsHtml = note.tags
          .slice(0, 3)
          .map(
            (
              tag // Show max 3 tags
            ) =>
              `<span class="inline-block bg-light-tertiary-container dark:bg-dark-tertiary-container text-light-on-tertiary-container dark:text-dark-on-tertiary-container text-xs px-2.5 py-1 rounded-lg">${tag}</span>`
          )
          .join("");

        const favoriteIconHtml = note.isFavorite
          ? '<span class="material-symbols-outlined text-yellow-500 dark:text-yellow-400 text-lg fill absolute top-2 right-2">star</span>'
          : "";
        const noteTypeIcon = note.type === "text" ? "article" : "graphic_eq";

        return `
                <div class="bg-light-surface dark:bg-dark-surface rounded-2xl border border-light-outline dark:border-dark-outline p-4 md:p-5 flex flex-col justify-between cursor-pointer hover:shadow-m3-light dark:hover:shadow-m3-dark transition-shadow relative group" 
                     onclick="openNote('${note.id}')">
                    ${favoriteIconHtml}
                    <div>
                        <h3 class="text-md font-medium text-light-on-surface dark:text-dark-on-surface mb-2 truncate pr-6">${
                          note.title || "Bez tytuÅ‚u"
                        }</h3>
                        ${
                          note.type === "text"
                            ? `
                            <p class="text-sm text-light-on-surface-variant dark:text-dark-on-surface-variant mb-3 line-clamp-4">${
                              note.content || ""
                            }</p>
                        `
                            : `
                            <div class="flex items-center text-sm text-light-on-surface-variant dark:text-dark-on-surface-variant mb-3">
                                <span class="material-symbols-outlined mr-2 text-lg">${noteTypeIcon}</span> Nagranie gÅ‚osowe
                            </div>
                        `
                        }
                    </div>
                    <div class="mt-auto">
                        ${
                          note.tags.length > 0
                            ? `<div class="mb-3 flex flex-wrap gap-1.5">${tagsHtml}</div>`
                            : ""
                        }
                        <div class="flex items-center justify-between text-xs text-light-on-surface-variant/80 dark:text-dark-on-surface-variant/80">
                            <span>${date}</span>
                            <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="event.stopPropagation(); editNote('${
                                  note.id
                                }')" 
                                        class="p-1.5 hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant rounded-full">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button onclick="event.stopPropagation(); confirmDeleteNoteAction('${
                                  note.id
                                }')" 
                                        class="p-1.5 hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant rounded-full">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      }

      // Event listeners
      function setupEventListeners() {
        // FAB and its menu
        const fabButtons = [fab, fabDesktop];
        const fabMenus = [fabMenu, fabMenuDesktop];
        const fabIcons = [fabIcon, fabIconDesktop];

        fabButtons.forEach((button, index) => {
          if (!button) return;
          button.addEventListener("click", (e) => {
            e.stopPropagation();
            fabMenus[index].classList.toggle("opacity-0");
            fabMenus[index].classList.toggle("scale-95");
            fabMenus[index].classList.toggle("pointer-events-none");
            fabIcons[index].classList.toggle("rotate-45");
          });
        });

        document.addEventListener("click", () => {
          // Close FAB menu on outside click
          fabMenus.forEach((menu, index) => {
            if (!menu.classList.contains("opacity-0")) {
              menu.classList.add(
                "opacity-0",
                "scale-95",
                "pointer-events-none"
              );
              fabIcons[index].classList.remove("rotate-45");
            }
          });
        });

        ["add-text-note-fab", "add-text-note-fab-desktop"].forEach((id) =>
          document
            .getElementById(id)
            ?.addEventListener("click", () => openNoteModal("text"))
        );
        ["add-voice-note-fab", "add-voice-note-fab-desktop"].forEach((id) =>
          document
            .getElementById(id)
            ?.addEventListener("click", () => openNoteModal("voice"))
        );

        document
          .getElementById("close-modal")
          .addEventListener("click", closeNoteModal);
        document
          .getElementById("cancel-note")
          .addEventListener("click", closeNoteModal);
        document
          .getElementById("save-note")
          .addEventListener("click", saveNote);

        document
          .getElementById("record-button")
          .addEventListener("click", toggleRecording);
        document
          .getElementById("pause-recording")
          .addEventListener("click", togglePauseResumeRecording);
        document
          .getElementById("stop-recording")
          .addEventListener("click", stopRecording);
        document
          .getElementById("re-record")
          .addEventListener("click", resetRecordingUIAndStart);

        document
          .getElementById("search-input")
          .addEventListener("input", renderNotes);

        document.querySelectorAll(".filter-type-button").forEach((button) => {
          button.addEventListener("click", (e) => {
            e.preventDefault();
            document.querySelectorAll(".filter-type-button").forEach((btn) => {
              btn.classList.remove(
                "active-filter",
                "bg-light-primary-container",
                "dark:bg-dark-primary-container",
                "text-light-on-primary-container",
                "dark:text-dark-on-primary-container"
              );
              btn.classList.add(
                "text-light-on-surface-variant",
                "dark:text-dark-on-surface-variant"
              ); // Reset to default text color
            });
            button.classList.add(
              "active-filter",
              "bg-light-primary-container",
              "dark:bg-dark-primary-container",
              "text-light-on-primary-container",
              "dark:text-dark-on-primary-container"
            );
            button.classList.remove(
              "text-light-on-surface-variant",
              "dark:text-dark-on-surface-variant"
            );
            renderNotes();
            if (window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile after selection
          });
        });

        document
          .getElementById("confirm-cancel")
          .addEventListener("click", closeConfirmModal);
        document
          .getElementById("confirm-delete")
          .addEventListener("click", executeDeleteNote);

        themeToggleButton.addEventListener("click", toggleTheme);

        noteModal.addEventListener("click", (e) => {
          if (e.target === noteModal) closeNoteModal();
        });
        confirmModal.addEventListener("click", (e) => {
          if (e.target === confirmModal) closeConfirmModal();
        });

        document
          .getElementById("note-tags-input")
          .addEventListener("keypress", handleTagInput);
        favoriteCheckbox.addEventListener("change", updateFavoriteIconInModal);

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "n") {
            e.preventDefault();
            openNoteModal(e.shiftKey ? "voice" : "text");
          }
          if (e.key === "Escape") {
            if (!noteModal.classList.contains("hidden")) closeNoteModal();
            if (!confirmModal.classList.contains("hidden")) closeConfirmModal();
            const audioPlayerModal = document.querySelector(
              "body > .fixed.bg-black\\/50"
            ); // Adjusted selector
            if (audioPlayerModal && audioPlayerModal.querySelector("audio")) {
              audioPlayerModal.remove();
              const audioSrc =
                audioPlayerModal.querySelector("audio source")?.src;
              if (audioSrc && audioSrc.startsWith("blob:"))
                URL.revokeObjectURL(audioSrc);
            }
            // Close FAB menu if open
            fabMenus.forEach((menu, index) => {
              if (!menu.classList.contains("opacity-0")) {
                menu.classList.add(
                  "opacity-0",
                  "scale-95",
                  "pointer-events-none"
                );
                fabIcons[index].classList.remove("rotate-45");
              }
            });
            // Close sidebar if open
            if (sidebar.classList.contains("sidebar-open")) toggleSidebar();
          }
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
            if (!noteModal.classList.contains("hidden")) {
              e.preventDefault();
              saveNote();
            }
          }
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "f") {
            e.preventDefault();
            document.getElementById("search-input").focus();
          }
        });
      }

      function updateFavoriteIconInModal() {
        const iconSpan = favoriteCheckbox.parentElement.querySelector(
          ".material-symbols-outlined"
        );
        if (favoriteCheckbox.checked) {
          iconSpan.classList.add(
            "fill",
            "text-yellow-500",
            "dark:text-yellow-400"
          );
          iconSpan.classList.remove(
            "text-light-on-surface-variant",
            "dark:text-dark-on-surface-variant"
          );
        } else {
          iconSpan.classList.remove(
            "fill",
            "text-yellow-500",
            "dark:text-yellow-400"
          );
          iconSpan.classList.add(
            "text-light-on-surface-variant",
            "dark:text-dark-on-surface-variant"
          );
        }
      }

      // Modal functions
      function openNoteModal(type, noteId = null) {
        currentNote = noteId
          ? notes.find((n) => n.id === noteId)
          : { type: type, tags: [], isFavorite: false, createdAt: Date.now() };

        document.getElementById("modal-title").textContent =
          currentNote.id && noteId ? `Edytuj notatkÄ™` : `Nowa notatka`;

        document.getElementById("note-title").value = currentNote.title || "";
        document.getElementById("note-content").value =
          currentNote.type === "text" ? currentNote.content || "" : "";
        document.getElementById("voice-note-title").value =
          currentNote.type === "voice" ? currentNote.title || "" : "";
        document.getElementById("note-reminder").value = currentNote.reminderAt
          ? new Date(
              currentNote.reminderAt - new Date().getTimezoneOffset() * 60000
            )
              .toISOString()
              .slice(0, 16)
          : "";

        favoriteCheckbox.checked = currentNote.isFavorite || false;
        updateFavoriteIconInModal();

        currentTags = new Set(currentNote.tags || []);
        renderTagChipsInModal();
        document.getElementById("note-tags-input").value = "";

        const textForm = document.getElementById("text-note-form");
        const voiceForm = document.getElementById("voice-note-form");

        if (type === "text") {
          textForm.classList.remove("hidden");
          voiceForm.classList.add("hidden");
        } else {
          textForm.classList.add("hidden");
          voiceForm.classList.remove("hidden");
          voiceForm.classList.add("flex");
          resetRecordingUI();
          if (currentNote.id && noteId && currentNote.audioBlob) {
            const audioUrl = URL.createObjectURL(currentNote.audioBlob);
            document.getElementById("recorded-audio").src = audioUrl;
            document
              .getElementById("audio-playback")
              .classList.remove("hidden");
            document.getElementById("recording-status").classList.add("hidden");
          }
        }

        noteModal.classList.remove("hidden");
        noteModal.classList.add("flex");
      }

      function closeNoteModal() {
        noteModal.classList.add("hidden");
        noteModal.classList.remove("flex");
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach((track) => track.stop());
        }
        clearRecordingTimer();
        currentNote = null;
        recordedAudioBlob = null;
        currentTags.clear();
      }

      // Tag Management
      function renderTagChipsInModal() {
        const container = document.getElementById("tag-chip-input-container");
        container.innerHTML = "";
        currentTags.forEach((tag) => {
          const chip = document.createElement("span");
          chip.className =
            "flex items-center px-2.5 py-1.5 bg-light-secondary-container dark:bg-dark-secondary-container text-light-on-secondary-container dark:text-dark-on-secondary-container rounded-lg text-xs font-medium";
          chip.textContent = tag;
          const closeIcon = document.createElement("span");
          closeIcon.className =
            "material-symbols-outlined ml-1.5 cursor-pointer text-xs hover:opacity-75";
          closeIcon.textContent = "close";
          closeIcon.onclick = () => {
            currentTags.delete(tag);
            renderTagChipsInModal();
          };
          chip.appendChild(closeIcon);
          container.appendChild(chip);
        });
      }

      function handleTagInput(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          const input = event.target;
          const tag = input.value.trim().replace(/,/g, ""); // Remove commas
          if (tag && currentTags.size < 10) {
            // Limit number of tags
            currentTags.add(tag);
            renderTagChipsInModal();
            input.value = "";
          } else if (tag && currentTags.size >= 10) {
            showToast("MoÅ¼esz dodaÄ‡ maksymalnie 10 tagÃ³w.", "warning");
          }
        }
      }

      // Recording functions
      let isRecordingPaused = false;
      async function toggleRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          stopRecording();
        } else {
          await startRecording();
        }
      }
      async function startRecording() {
        /* ... (same as before, with UI updates) ... */
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showToast("API MediaDevices nie jest wspierane.", "error");
          return;
        }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream, {
            mimeType: "audio/webm;codecs=opus",
          });
          audioChunks = [];
          recordedAudioBlob = null;
          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) audioChunks.push(event.data);
          };
          mediaRecorder.onstop = () => {
            if (audioChunks.length > 0) {
              recordedAudioBlob = new Blob(audioChunks, {
                type: mediaRecorder.mimeType,
              });
              const audioUrl = URL.createObjectURL(recordedAudioBlob);
              document.getElementById("recorded-audio").src = audioUrl;
              document
                .getElementById("audio-playback")
                .classList.remove("hidden");
            }
            if (mediaRecorder && mediaRecorder.stream)
              mediaRecorder.stream.getTracks().forEach((track) => track.stop());
            mediaRecorder = null;
            clearRecordingTimer();
            document.getElementById("recording-status").classList.add("hidden");
            document
              .getElementById("recording-controls")
              .classList.add("hidden");
            document
              .getElementById("recording-controls")
              .classList.remove("flex");
            document
              .getElementById("audio-playback")
              .classList.remove("hidden");
            showToast("Nagrywanie zakoÅ„czone", "success");
          };
          mediaRecorder.onstart = () => {
            recordingStartTime = Date.now();
            startRecordingTimer();
            document.getElementById("recording-status").classList.add("hidden");
            document
              .getElementById("recording-controls")
              .classList.remove("hidden");
            document.getElementById("recording-controls").classList.add("flex");
            document.getElementById("pause-recording").innerHTML =
              '<span class="material-symbols-outlined">pause</span>';
            isRecordingPaused = false;
            showToast("Nagrywanie rozpoczÄ™te", "info");
            document
              .getElementById("record-button")
              .classList.add("animate-pulse-opacity"); // For main record button if visible
          };
          mediaRecorder.start();
        } catch (error) {
          console.error("BÅ‚Ä…d nagrywania:", error);
          showToast("BÅ‚Ä…d dostÄ™pu do mikrofonu: " + error.message, "error");
        }
      }
      function togglePauseResumeRecording() {
        /* ... (same as before, with UI updates) ... */
        if (!mediaRecorder) return;
        const pauseButton = document.getElementById("pause-recording");
        const timerDisplay = document.getElementById("recording-timer");
        if (mediaRecorder.state === "recording") {
          mediaRecorder.pause();
          isRecordingPaused = true;
          clearRecordingTimer();
          pauseButton.innerHTML =
            '<span class="material-symbols-outlined">play_arrow</span>';
          timerDisplay.classList.add("animate-pulse-opacity");
          showToast("Nagrywanie wstrzymane", "info");
        } else if (mediaRecorder.state === "paused") {
          mediaRecorder.resume();
          isRecordingPaused = false;
          startRecordingTimer(true);
          pauseButton.innerHTML =
            '<span class="material-symbols-outlined">pause</span>';
          timerDisplay.classList.remove("animate-pulse-opacity");
          showToast("Nagrywanie wznowione", "info");
        }
      }
      function stopRecording() {
        /* ... (same as before, with UI updates) ... */
        if (mediaRecorder && mediaRecorder.state !== "inactive")
          mediaRecorder.stop();
        document
          .getElementById("record-button")
          .classList.remove("animate-pulse-opacity");
        document
          .getElementById("recording-timer")
          .classList.remove("animate-pulse-opacity");
      }
      function resetRecordingUI() {
        /* ... (same as before, with UI updates) ... */
        if (mediaRecorder && mediaRecorder.state !== "inactive")
          mediaRecorder.stop();
        clearRecordingTimer();
        audioChunks = [];
        recordedAudioBlob = null;
        document.getElementById("recording-status").classList.remove("hidden");
        document.getElementById("recording-controls").classList.add("hidden");
        document.getElementById("recording-controls").classList.remove("flex");
        document.getElementById("audio-playback").classList.add("hidden");
        document.getElementById("recorded-audio").src = "";
        document.getElementById("recording-timer").textContent = "00:00";
        document
          .getElementById("record-button")
          .classList.remove("animate-pulse-opacity");
        document
          .getElementById("recording-timer")
          .classList.remove("animate-pulse-opacity");
      }
      async function resetRecordingUIAndStart() {
        resetRecordingUI();
        await startRecording();
      }

      function startRecordingTimer(isResuming = false) {
        /* ... (same as before) ... */
        clearRecordingTimer();
        if (!isResuming) recordingStartTime = Date.now();
        const timerDisplay = document.getElementById("recording-timer");

        function updateTimer() {
          const elapsed = Date.now() - recordingStartTime;
          const minutes = Math.floor(elapsed / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);
          timerDisplay.textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }
        updateTimer(); // Initial call
        recordingTimerInterval = setInterval(updateTimer, 1000);
      }
      function clearRecordingTimer() {
        clearInterval(recordingTimerInterval);
        recordingTimerInterval = null;
      }

      // Save note
      async function saveNote() {
        /* ... (mostly same, ensure currentNote is used for new notes too) ... */
        try {
          const isTextNote = currentNote.type === "text";
          const title = (
            isTextNote
              ? document.getElementById("note-title").value
              : document.getElementById("voice-note-title").value
          ).trim();

          if (!title) {
            showToast("TytuÅ‚ jest wymagany.", "error");
            return;
          }

          currentNote.title = title;
          currentNote.tags = Array.from(currentTags);
          currentNote.isFavorite = favoriteCheckbox.checked;
          const reminderInput = document.getElementById("note-reminder").value;
          currentNote.reminderAt = reminderInput
            ? new Date(reminderInput).getTime()
            : null;
          currentNote.updatedAt = Date.now();

          if (isTextNote) {
            currentNote.content = document
              .getElementById("note-content")
              .value.trim();
            if (!currentNote.content) {
              showToast("TreÅ›Ä‡ notatki jest wymagana.", "error");
              return;
            }
          } else {
            // Voice note
            if (recordedAudioBlob) {
              // New recording or re-recording
              currentNote.audioBlob = recordedAudioBlob;
            } else if (!currentNote.audioBlob) {
              // No existing blob and no new recording
              showToast("Nagraj audio przed zapisaniem.", "error");
              return;
            }
          }
          if (!currentNote.id) currentNote.id = generateId(); // Generate ID if new note

          await saveNoteToDb(currentNote);

          const existingIndex = notes.findIndex((n) => n.id === currentNote.id);
          if (existingIndex >= 0) notes[existingIndex] = { ...currentNote };
          else notes.unshift({ ...currentNote });
          notes.sort((a, b) => b.createdAt - a.createdAt);

          if (currentNote.reminderAt && currentNote.reminderAt > Date.now())
            setReminder(currentNote);

          renderNotes();
          updateTagFilterUI();
          closeNoteModal();
          showToast(`Notatka "${currentNote.title}" zapisana.`, "success");
        } catch (error) {
          console.error("BÅ‚Ä…d zapisu notatki:", error);
          showToast("BÅ‚Ä…d podczas zapisywania notatki: " + error, "error");
        }
      }

      // Open note for viewing/playing
      function openNote(id) {
        /* ... (same as before, using new modal styles if any) ... */
        const note = notes.find((n) => n.id === id);
        if (!note) return;

        if (note.type === "voice") {
          if (note.audioBlob instanceof Blob) {
            const audioUrl = URL.createObjectURL(note.audioBlob);
            const audioPlayerModal = document.createElement("div");
            audioPlayerModal.className =
              "fixed inset-0 bg-black/50 dark:bg-black/70 z-[70] flex items-center justify-center p-4 backdrop-blur-sm"; // Higher z-index
            audioPlayerModal.innerHTML = `
                        <div class="bg-light-surface dark:bg-dark-surface rounded-3xl max-w-md w-full p-6 shadow-xl relative">
                            <button class="absolute top-3 right-3 p-2 text-light-on-surface-variant dark:text-dark-on-surface-variant hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant rounded-full" 
                                    onclick="this.closest('.fixed').remove(); URL.revokeObjectURL('${audioUrl}');">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                            <h3 class="text-lg font-medium text-light-on-surface dark:text-dark-on-surface mb-4">${
                              note.title
                            }</h3>
                            <audio controls autoplay class="w-full mb-4 rounded-lg">
                                <source src="${audioUrl}" type="${
              note.audioBlob.type || "audio/webm"
            }">
                            </audio>
                            <div class="text-xs text-light-on-surface-variant dark:text-dark-on-surface-variant">
                                <p>Utworzono: ${new Date(
                                  note.createdAt
                                ).toLocaleString("pl-PL", {
                                  dateStyle: "medium",
                                  timeStyle: "short",
                                })}</p>
                                ${
                                  note.tags.length > 0
                                    ? `<p class="mt-1">Tagi: ${note.tags.join(
                                        ", "
                                      )}</p>`
                                    : ""
                                }
                            </div>
                        </div>
                    `;
            document.body.appendChild(audioPlayerModal);
            const audioEl = audioPlayerModal.querySelector("audio");
            audioEl.onended = () => URL.revokeObjectURL(audioUrl);
            audioEl.onerror = () => {
              showToast("BÅ‚Ä…d odtwarzania audio.", "error");
              URL.revokeObjectURL(audioUrl);
            };
          } else {
            showToast("Nie moÅ¼na odtworzyÄ‡ notatki gÅ‚osowej.", "error");
          }
        } else {
          editNote(id);
        }
      }

      // Edit note
      function editNote(id) {
        const note = notes.find((n) => n.id === id);
        if (note) openNoteModal(note.type, id);
      }

      // Delete note
      let noteIdToDelete = null;
      function confirmDeleteNoteAction(id) {
        /* ... (same as before) ... */
        noteIdToDelete = id;
        const note = notes.find((n) => n.id === id);
        if (!note) return;
        document.getElementById(
          "confirm-message"
        ).textContent = `Czy na pewno chcesz usunÄ…Ä‡ notatkÄ™ "${note.title}"?`;
        confirmModal.classList.remove("hidden");
        confirmModal.classList.add("flex");
      }
      function closeConfirmModal() {
        /* ... (same as before) ... */ confirmModal.classList.add("hidden");
        confirmModal.classList.remove("flex");
        noteIdToDelete = null;
      }
      async function executeDeleteNote() {
        /* ... (same as before) ... */
        if (!noteIdToDelete) return;
        try {
          await deleteNoteFromDb(noteIdToDelete);
          notes = notes.filter((n) => n.id !== noteIdToDelete);
          renderNotes();
          updateTagFilterUI();
          closeConfirmModal();
          showToast("Notatka zostaÅ‚a usuniÄ™ta.", "success");
        } catch (error) {
          console.error("BÅ‚Ä…d usuwania:", error);
          showToast("BÅ‚Ä…d podczas usuwania notatki: " + error, "error");
        }
      }

      // Tag filter UI management
      function updateTagFilterUI() {
        const tagContainer = document.getElementById("tag-filter");
        const allTags = [...new Set(notes.flatMap((note) => note.tags))].sort(
          (a, b) => a.localeCompare(b)
        );

        if (allTags.length === 0) {
          tagContainer.innerHTML =
            '<p class="px-3 py-2 text-xs text-light-on-surface-variant dark:text-dark-on-surface-variant">Brak tagÃ³w.</p>';
          return;
        }
        tagContainer.innerHTML = allTags
          .map(
            (tag) => `
                <label class="flex items-center px-3 py-2 rounded-full cursor-pointer hover:bg-light-surface-variant dark:hover:bg-dark-surface-variant group">
                    <input type="checkbox" value="${tag}" class="h-4 w-4 text-light-primary dark:text-dark-primary bg-light-surface-variant dark:bg-dark-surface-variant border-light-outline dark:border-dark-outline rounded focus:ring-light-primary dark:focus:ring-dark-primary focus:ring-offset-0" onchange="renderNotes()">
                    <span class="ml-3 text-sm text-light-on-surface-variant dark:text-dark-on-surface-variant group-hover:text-light-on-surface dark:group-hover:text-dark-on-surface">${tag}</span>
                </label>
            `
          )
          .join("");
      }

      // Reminders
      function setReminder(note) {
        /* ... (same as before, consider M3 icon for notification) ... */
        const timeUntilReminder = note.reminderAt - Date.now();
        if (timeUntilReminder > 0) {
          setTimeout(() => {
            const currentNoteState = notes.find((n) => n.id === note.id);
            if (
              currentNoteState &&
              currentNoteState.reminderAt === note.reminderAt
            ) {
              // Check if reminder wasn't cancelled/changed
              if (
                "Notification" in window &&
                Notification.permission === "granted"
              ) {
                new Notification(`Przypomnienie: ${note.title}`, {
                  body:
                    note.type === "text"
                      ? note.content.substring(0, 100) +
                        (note.content.length > 100 ? "..." : "")
                      : "Notatka gÅ‚osowa",
                  icon: "https://fonts.gstatic.com/s/i/short-term/release/znamky.webp/discover/v11/24px.png", // Placeholder icon
                });
              }
              showToast(`ðŸ”” Przypomnienie: ${note.title}`, "info", 6000);
            }
          }, timeUntilReminder);
        }
      }

      // Theme toggle
      function toggleTheme() {
        isDarkMode = !isDarkMode;
        const themeIcon = themeToggleButton.querySelector(
          ".material-symbols-outlined"
        );
        if (isDarkMode) {
          document.documentElement.classList.add("dark");
          themeIcon.textContent = "light_mode";
          themeToggleText.textContent = "Jasny motyw";
        } else {
          document.documentElement.classList.remove("dark");
          themeIcon.textContent = "dark_mode";
          themeToggleText.textContent = "Ciemny motyw";
        }
        localStorage.setItem("notesAppThemeM3", isDarkMode ? "dark" : "light");
      }

      function loadPreferences() {
        const savedTheme = localStorage.getItem("notesAppThemeM3");
        const themeIcon = themeToggleButton.querySelector(
          ".material-symbols-outlined"
        );
        if (savedTheme === "dark") {
          isDarkMode = true;
          document.documentElement.classList.add("dark");
          themeIcon.textContent = "light_mode";
          themeToggleText.textContent = "Jasny motyw";
        } else {
          isDarkMode = false;
          document.documentElement.classList.remove("dark");
          themeIcon.textContent = "dark_mode";
          themeToggleText.textContent = "Ciemny motyw";
        }
      }

      // Toast notifications
      function showToast(message, type = "info", duration = 4000) {
        /* ... (same as before, with M3-like styling) ... */
        const toastContainer = document.getElementById("toast-container");
        const toast = document.createElement("div");
        let colors, iconName;

        switch (type) {
          case "success":
            colors = "bg-green-600 dark:bg-green-500 text-white";
            iconName = "check_circle";
            break;
          case "error":
            colors = "bg-red-600 dark:bg-red-500 text-white";
            iconName = "error";
            break;
          case "warning":
            colors =
              "bg-yellow-500 dark:bg-yellow-400 text-black dark:text-gray-900";
            iconName = "warning";
            break;
          default:
            colors =
              "bg-slate-700 dark:bg-slate-200 text-white dark:text-slate-800";
            iconName = "info";
            break; // M3 snackbar style
        }

        toast.className = `flex items-center px-4 py-3 rounded-lg shadow-lg ${colors} text-sm font-medium transform transition-all duration-300 opacity-0 translate-y-4`;
        toast.innerHTML = `<span class="material-symbols-outlined mr-2.5">${iconName}</span><span>${message}</span>`;
        toastContainer.appendChild(toast);

        requestAnimationFrame(() => {
          // Ensure layout before transition
          toast.classList.remove("opacity-0", "translate-y-4");
          toast.classList.add("opacity-100", "translate-y-0");
        });

        setTimeout(() => {
          toast.classList.remove("opacity-100", "translate-y-0");
          toast.classList.add("opacity-0", "translate-y-4");
          setTimeout(() => {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
          }, 300);
        }, duration);
      }

      // Utility functions
      function generateId() {
        return (
          Date.now().toString(36) + Math.random().toString(36).substring(2, 11)
        );
      }

      // Auto-save (conceptual)
      let autoSaveTimeout;
      function setupAutoSave() {
        /* ... (same as before) ... */
        const titleInput = document.getElementById("note-title");
        const contentInput = document.getElementById("note-content");
        const voiceTitleInput = document.getElementById("voice-note-title");

        [titleInput, contentInput, voiceTitleInput].forEach((input) => {
          input.addEventListener("input", () => {
            if (
              noteModal.classList.contains("hidden") ||
              !currentNote ||
              !currentNote.id
            )
              return; // Only for existing notes being edited in an open modal

            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
              // Update currentNote in memory for immediate UI reflection if any
              currentNote.title = (
                currentNote.type === "text"
                  ? titleInput.value
                  : voiceTitleInput.value
              ).trim();
              if (currentNote.type === "text")
                currentNote.content = contentInput.value.trim();
              currentNote.updatedAt = Date.now();
              currentNote.tags = Array.from(currentTags); // Make sure tags are current

              try {
                // Lightweight save to DB without full UI refresh or toast
                await saveNoteToDb({ ...currentNote });
                // Update in local 'notes' array as well
                const existingIndex = notes.findIndex(
                  (n) => n.id === currentNote.id
                );
                if (existingIndex >= 0)
                  notes[existingIndex] = { ...currentNote };
                console.log(
                  "Notatka automatycznie zapisana:",
                  currentNote.title
                );
              } catch (err) {
                console.error("BÅ‚Ä…d automatycznego zapisu:", err);
              }
            }, 2500); // Auto-save after 2.5 seconds of inactivity
          });
        });
      }
    </script>
  </body>
</html>
